@startuml
title Capital Selector Architecture
skinparam classAttributeIconSize 0
skinparam defaultFontName "DejaVu Sans"
skinparam classFontName "DejaVu Sans"
skinparam noteFontName "DejaVu Sans"

package "capitalmarket.capitalselector" {

  abstract class Channel {
    +step(weight: float): (float r, float c)
  }

  interface PhaseCChannel {
    +step(weight: float): (float r, float c, bool alive, float dt)
  }

  class CapitalSelector {
    -wealth: float
    -rebirth_threshold: float
    -stats: EWMAStats
    -reweight_fn
    -kind: str
    -rebirth_policy: RebirthPolicy?
    -channels: list[Channel]
    -w: ndarray?

    +allocate(): ndarray?
    +stack_step(): void
    +feedback(r: float, c: float): void
    +feedback_vector(r_vec: ndarray, c: float): void
    +rebirth(): void
    +state(): dict
  }

  class EWMAStats {
    +mu: float
    +var: float
    +update(x: float): void
  }

  class StackChannel {
    -members: dict[str, PhaseCChannel]
    -cfg: StackConfig
    +step(weight: float): (float r, float c, bool alive, float dt)
    +stable(): bool
    +state(): dict
  }

  class StackManager {
    -stacks: dict[str, StackChannel]
    -sediment: SedimentDAG?
    +try_form_stack(...)
    +maintain(...)
  }

  interface RebirthPolicy {
    +on_rebirth(selector: CapitalSelector): void
  }

  class SedimentNode {
    +node_id: int
    +members: list[str]
    +mask: dict
    +world_id: str
    +phase_id: str
    +t: int
    +run_id: str
  }

  class SedimentDAG {
    -nodes: dict[int, SedimentNode]
    +add_node(...)
    +is_forbidden(candidate_members, phase_id): bool
  }

  Channel <|-- CapitalSelector
  PhaseCChannel <|-- StackChannel
  CapitalSelector o-- EWMAStats
  CapitalSelector o-- RebirthPolicy
  CapitalSelector o-- Channel : stacks
  StackManager o-- StackChannel
  StackManager o-- SedimentDAG
  SedimentDAG o-- SedimentNode
}

note right of Channel
Implements the notion of a capital channel.

math-v1.md §2.2:
R_i(t) = Σ_k w_ik r_k(t)
C_i(t) explicit and subtractive
end note

note right of CapitalSelector
Canonical unit / mediator.

math-v1.md:
§1.1 Units (w ∈ Δⁿ)
§2 Weight Update (Exponentiated Gradient via reweight_fn)
§3 Statistics (μ, σ²)
§7 Rebirth (state reset, history preserved)
end note

note right of EWMAStats
Exponential statistics.

math-v1.md §6:
μ(t), σ²(t) via EWMA
end note

note right of StackChannel
Aggregated stack identity.

math-v1.md §7:
Stack return and stability
end note

note right of SedimentDAG
Passive structural memory.

math-v1.md §8:
Sediment nodes (ν)
Append-only DAG
Hard exclusion via is_forbidden
end note

@enduml
